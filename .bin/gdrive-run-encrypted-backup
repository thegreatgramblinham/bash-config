#!/usr/bin/env bash
# This command is intended run on a machine with
#  - rclone set up with a 'gdrive-remote' remote
#  - a 'GDrive-Key' gpg key

while getopts 't:' OPTION; do
    case "$OPTION" in
        t)
            #Target directory
            targetDir="$OPTARG"
            ;;
        ?)
            echo "Invalid usage!"
            echo "gdrive-run-encrypted-backup [-t target_directory_to_encrypt_and_sync]"
            exit 1;
            ;;
    esac
done


if [[ ! -d "$targetDir" ]]; then
    echo "Target directory to encrypt and upload doesn't exist. Exiting..."
    exit 1
fi

# Build an archive name with the directory and timestamp
baseName=$(basename "$targetDir")
currentDate=$(date '+%Y-%m-%d')
tarName="$baseName-$currentDate.tar.gpg"

# Make an encrypted tar out of the target directory
gpgtar --encrypt --output "$tarName" -r 'GDrive-Key' "$targetDir"
    \|| (echo ">Creating gpgtar failed. Exiting..."; exit 1)

# Move that tar to the directory syncing with Google Drive via rclone
googleDriveSyncDir="/mnt/gdrive-sync"
if [[ ! -d $googleDriveSyncDir ]]; then
    echo ">Google Drive sync directory does not exist."
    echo ">Cleaning up tar.gpg..."
    rm "$tarName"
    echo ">Exiting..."
fi
sudo mv "$targetDir/$tarName" "$googleDriveSyncDir/$tarName"

# Run the sync operation on that directory to 'push' the changes
googleDriveRemoteName="gdrive-remote"
rclone sync "$googleDriveSyncDir" "$googleDriveRemoteName":
